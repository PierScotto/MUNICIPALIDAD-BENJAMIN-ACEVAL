<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <link href="/output.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ef4444 0%, #10b981 100%);
      min-height: 100vh;
    }
    .dashboard-card {
      background: rgba(255,255,255,0.97);
      border-radius: 2rem;
      box-shadow: 0 12px 40px rgba(16,185,129,0.10), 0 2px 8px rgba(239,68,68,0.08);
      padding: 3rem 2.5rem;
      max-width: 600px;
      margin: 2rem auto;
    }
    .big-btn {
      font-size: 1.3rem;
      padding: 1.2rem 0;
      border-radius: 1.2rem;
      box-shadow: 0 4px 24px rgba(16,185,129,0.13);
      font-weight: 700;
      letter-spacing: 0.03em;
      transition: box-shadow 0.2s, transform 0.2s;
      background: linear-gradient(90deg, #10b981, #34d399);
      color: #fff;
    }
    .big-btn:hover {
      box-shadow: 0 8px 32px rgba(239,68,68,0.13);
      transform: translateY(-2px) scale(1.03);
    }
    .file-list {
      margin-top: 2.5rem;
    }
    .file-item {
      background: #f3f4f6;
      border-radius: 1rem;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 2.5rem;
      box-shadow: 0 2px 8px rgba(16,185,129,0.07);
    }
    .file-thumb {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 0.75rem;
      border: 2px solid #10b981;
    }
    .file-meta {
      flex: 1;
    }
    .file-date {
      color: #6b7280;
      font-size: 0.95rem;
    }
    .logout-btn {
      font-size: 1rem;
      padding: 0.7rem 1.5rem;
      border-radius: 1rem;
      border: 2px solid #ef4444;
      color: #ef4444;
      font-weight: 600;
      background: #fff;
      transition: background 0.2s, color 0.2s;
    }
    .logout-btn:hover {
      background: #fee2e2;
      color: #b91c1c;
    }
  </style>
</head>
<body class="gradient-bg p-6 min-h-screen">
  <div class="dashboard-card">
    <div class="mb-8 flex justify-center">
      <div class="bg-white/90 rounded-2xl shadow-lg px-8 py-6 flex flex-col items-center w-full max-w-md border border-gray-200">
        <h1 class="text-4xl font-extrabold text-brandRed mb-2 border-b-2 border-brandRed pb-2 w-full text-center" id="username">Usuario</h1>
        <p class="text-gray-700 text-lg font-medium mb-2 w-full text-center" id="userEmail"></p>
      </div>
    </div>
    <div style="height: 2.5rem;"></div>
    <form id="uploadForm" class="mb-10 flex flex-col items-center">
      <label class="block mb-4 font-extrabold text-2xl text-brandGreen tracking-wide text-center">Selecciona tu Foto - Archivo</label>
      <div class="relative w-full max-w-xs mb-4">
        <input id="fileInput" type="file" name="file" accept="image/*" required class="w-full px-4 py-3 rounded-2xl border-2 border-brandGreen focus:border-emerald-400 transition-colors bg-white shadow-lg file-input-modern" />
        <span id="filePlaceholder" class="absolute left-0 top-0 w-full h-full flex items-center justify-center text-gray-400 pointer-events-none text-lg font-semibold">Ning√∫n archivo seleccionado</span>
      </div>
      <button type="submit" class="big-btn w-full bg-gradient-to-r from-brandGreen to-emerald-400 text-white text-xl font-bold shadow-lg hover:shadow-green-200/50 transform hover:-translate-y-1 transition-all duration-200">
        <span class="inline-block align-middle mr-2">üì§</span> Publicar Archivo
      </button>
    </form>
    </form>
    <div class="flex flex-col md:flex-row gap-8 items-start mt-8">
      <div class="w-full md:w-1/3 bg-white/80 rounded-xl shadow p-6 mb-8 md:mb-0">
        <h2 class="text-xl font-bold text-brandGreen mb-4 text-center">Cantidad de Archivos Subidos</h2>
  <div class="text-6xl font-extrabold text-brandRed text-center mb-2" id="filesCount">0</div>
  <!-- Texto 'Total de archivos' eliminado -->
        <h2 class="text-xl font-bold text-red-600 mb-2 text-center">Cantidad de Archivos Eliminados</h2>
  <div class="text-6xl font-extrabold text-red-500 text-center mb-2" id="deletedFilesCount">0</div>
  <button id="showDeletedBtn" class="px-4 py-2 rounded-full bg-red-500 text-white font-bold hover:bg-red-700 transition w-full">Ver Detalles</button>
      </div>
    <!-- Modal para archivos eliminados -->
    <div id="deletedModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg">
        <h2 class="text-2xl font-bold text-red-600 mb-4 text-center">Detalles de Archivos Eliminados</h2>
        <div id="deletedFilesList" class="space-y-4"></div>
  <!-- Bot√≥n de cerrar eliminado -->
      </div>
    </div>
      <div class="w-full md:w-2/3">
        <h2 class="text-xl font-bold text-brandGreen mb-4 text-center">Tus Archivos Subidos</h2>
        <div class="file-list" id="filesList"></div>
      </div>
    </div>
    <div class="flex justify-center mt-10">
      <div class="bg-black rounded-xl shadow-lg p-4 flex items-center justify-center" style="min-width: 140px;">
        <button id="logout" class="logout-btn" style="background:#111;color:#fff;border:none;">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

    <template id="fileTemplate">
      <div class="file-item flex items-center gap-6 p-6 bg-white rounded-xl shadow-md mb-6">
        <img src="" class="file-thumb" alt="Foto" />
        <div class="file-meta flex flex-col">
          <div class="font-extrabold file-name text-2xl mb-2"></div>
          <div class="file-date text-gray-600 text-lg"></div>
        </div>
        <button class="delete-btn ml-auto px-4 py-2 rounded-lg bg-red-500 text-white font-bold hover:bg-red-700 transition" title="Eliminar archivo">üóëÔ∏è</button>
      </div>
    </template>

    <script>
      // Placeholder visual para input de archivo
      const fileInput = document.getElementById('fileInput');
      const filePlaceholder = document.getElementById('filePlaceholder');
      fileInput.addEventListener('change', () => {
        filePlaceholder.style.display = fileInput.files.length ? 'none' : 'flex';
      });
      const token = localStorage.getItem('token');
      if (!token) window.location.href = '/login.html';

    // Mostrar nombre y email del usuario
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      document.getElementById('username').textContent = payload.username || payload.email || 'Usuario';
      document.getElementById('userEmail').textContent = payload.email || '';
    } catch {}

    document.getElementById('logout').addEventListener('click', () => {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    });

    async function fetchFiles() {
      const res = await fetch('/api/files', { headers: { Authorization: 'Bearer ' + token } });
      const files = await res.json();
      // Mostrar n√∫mero total
      document.getElementById('filesCount').textContent = files.length;
      // Mostrar lista visual
      const container = document.getElementById('filesList');
      const template = document.getElementById('fileTemplate');
      container.innerHTML = '';
      files.forEach(f => {
        const clone = template.content.cloneNode(true);
        const card = clone.querySelector('.file-item');
        const img = card.querySelector('img');
        const nameDiv = card.querySelector('.file-name');
        const dateDiv = card.querySelector('.file-date');
        img.src = '/uploads/' + f.file_path;
        img.alt = f.file_name;
        nameDiv.textContent = f.file_name;
        dateDiv.textContent = new Date(f.created_at || f.uploaded_at).toLocaleString();
        // Bot√≥n eliminar
        const delBtn = card.querySelector('.delete-btn');
        delBtn.addEventListener('click', async () => {
          if (confirm('¬øSeguro que quieres eliminar este archivo?')) {
            const res = await fetch(`/api/files/${f.id}`, {
              method: 'DELETE',
              headers: { Authorization: 'Bearer ' + token }
            });
            const json = await res.json();
            alert(json.message || 'Archivo eliminado');
            if (res.ok) fetchFiles();
          }
        });
        container.appendChild(card);
      });
      // Obtener archivos eliminados
      const deletedRes = await fetch('/api/files/deleted', { headers: { Authorization: 'Bearer ' + token } });
      const deletedFiles = await deletedRes.json();
      document.getElementById('deletedFilesCount').textContent = deletedFiles.length;
      // Bot√≥n para mostrar modal
      document.getElementById('showDeletedBtn').onclick = () => {
        const modal = document.getElementById('deletedModal');
        const list = document.getElementById('deletedFilesList');
        list.innerHTML = '';
        if (deletedFiles.length === 0) {
          list.innerHTML = '<div class="text-center text-gray-500">No hay archivos eliminados.</div>';
        } else {
          deletedFiles.forEach(f => {
            const item = document.createElement('div');
            item.className = 'p-4 rounded-xl bg-red-50 flex flex-col gap-2 shadow';
            item.innerHTML = `<div class='font-bold text-lg text-red-700'>${f.file_name}</div><div class='text-gray-600 text-sm'>${new Date(f.deleted_at).toLocaleString()}</div>`;
            list.appendChild(item);
          });
        }
        modal.classList.remove('hidden');
      };
      document.getElementById('closeDeletedModal').onclick = () => {
        document.getElementById('deletedModal').classList.add('hidden');
      };
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const res = await fetch('/api/files/upload', { method: 'POST', headers: { Authorization: 'Bearer ' + token }, body: fd });
      const json = await res.json();
      alert(json.message || 'OK');
      if (res.ok) fetchFiles();
    });

    fetchFiles();
  </script>
</body>
</html>